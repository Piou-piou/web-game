services:
  caddy:
    image: caddy:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./public:/srv/app/public:ro
      - ./docker/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - php

  php:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    restart: unless-stopped
    volumes:
      - ./:/srv/app
    env_file:
      - .env
      - .env.dev
      - .env.local
    depends_on:
      - database

  worker:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    restart: unless-stopped
    command: php bin/console messenger:consume async -vv
    volumes:
      - ./:/srv/app
    env_file:
      - .env
      - .env.dev
      - .env.local
    depends_on:
      - database
      - php

  database:
    image: mariadb:11.4
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ChangeMe
      MYSQL_DATABASE: app
      MYSQL_USER: app
      MYSQL_PASSWORD: ChangeMe
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3306:3306"

  adminer:
    image: adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      - database

  gotenberg:
    image: gotenberg/gotenberg:8
    restart: unless-stopped
    ports:
      - "3000:3000"
    command:
      - "gotenberg"
      - "--api-port=3000"
      - "--api-timeout=30s"
      # Charge les moteurs n√©cessaires (Chromium + LibreOffice)
      - "--chromium-disable-routes=false"
      - "--libreoffice-disable-routes=false"

  mailpit:
    image: axllent/mailpit
    restart: unless-stopped
    ports:
      - "1025:1025" # Port SMTP
      - "8025:8025" # Interface Web
    environment:
      MP_MAX_MESSAGES: 5000

volumes:
  caddy_data:
  caddy_config:
  db_data:
